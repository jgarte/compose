(in-package :jgart.compose)

(defun read-lines (filepath-name)
  (let (lines)
    (with-open-file (stream filepath-name)
      (do ((line (read-line stream nil) (read-line stream nil)))
          ((null line))
        (push line lines)))
    (nreverse lines)))

(defun read-tone-rows (filepath-name)
  (let ((result '()))
    (let ((rows (read-lines filepath-name)))
      (dolist (row rows)
        (push (split-string row) result)))
    (nreverse result)))

(defun parse-tone-rows (filepath-name)
  (let ((result '())
        (tone-rows (read-tone-rows filepath-name)))
    (dolist (tone-row tone-rows)
      (when (< (length *universe*) (length tone-row))
        (error "You supplied ~a notes in one line but only 12 are allowed per line."
               (length tone-row)))
      (let ((row (make-list (length *universe*) :initial-element nil))
            (index 0))
        (dolist (note tone-row)
          (unless (>= index 12)
            (setf (elt row index) (parse-note note))
            (incf index)))
        (if (< index (length *universe*))
            (progn
              (let ((index 0))
                (dolist (complementary-note (comp row))
                  (when (null (nth index row))
                    (setf (elt row index) complementary-note))
                  (incf index)))
              (push row result))
            (push row result))))
    result))
